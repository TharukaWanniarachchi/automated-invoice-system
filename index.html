<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Sunset Escape - Billing System</title>

  <!-- PDF library (client-side) -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

          integrity="sha512-GsLlZN/3F2YjJ0v2wG3cK5JZV1L8mukwLQ4nV8yN1bDkqk+9E7p2hB3oHkC6v7d9VwzvD9+u5p7nF1Jx8qQq5A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --gold:#d9bf73;
      --text:#111;
      --muted:#444;
      --line:#ececec;
      --bg:#f3f4f6;
      --card:#ffffff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .app{
      max-width: 1100px;
      margin: 18px auto;
      padding: 0 14px 28px;
    }
    .top{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .brand img{
      width:44px;height:44px;object-fit:contain;background:#fff;border-radius:10px;border:1px solid #e5e7eb;
    }
    .brand .t1{ font-weight:900; font-size:18px; line-height:1; }
    .brand .t2{ font-size:12px; color:#555; margin-top:2px; }
    .pillbar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      border:1px solid #e5e7eb;
      background:#fff;
      padding:8px 10px;
      border-radius: 999px;
      font-size:12.5px;
      color:#222;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .cardHeader{
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(180deg, #fff, #fafafa);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }
    .cardHeader h2{
      font-size: 14px;
      margin:0;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .cardBody{ padding: 12px 14px 14px; }

    label{ display:block; font-size:12px; color:#333; font-weight:800; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      padding: 10px 10px;
      border:1px solid #d1d5db;
      border-radius: 10px;
      font-size: 13.5px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height: 64px; resize: vertical; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #111;
      background: #111;
      color:#fff;
      font-weight:900;
      font-size: 13px;
      cursor:pointer;
    }
    button.secondary{
      background:#fff;
      color:#111;
    }
    button.danger{
      background:#b91c1c;
      border-color:#b91c1c;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .items{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13.5px;
    }
    .items th{
      text-align:left;
      background: var(--gold);
      padding: 10px;
      font-weight: 900;
    }
    .items td{
      padding: 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    .items td.num, .items th.num{ text-align:right; }
    .items td.actions{ width: 40px; text-align:right; }
    .miniBtn{
      background:#fff;
      border:1px solid #d1d5db;
      color:#111;
      padding: 6px 8px;
      border-radius: 10px;
      font-weight: 900;
      cursor:pointer;
    }

    .previewWrap{ padding: 12px 14px 14px; }
    .previewTools{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin: 12px 0 0;
    }
    .hint{
      font-size: 12px;
      color:#555;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* ====== Rendered Document Template (A4) ====== */
    @page { size: A4; margin: 14mm; }
    .pageA4{
      width: 210mm;
      min-height: 297mm;
      background:#fff;
      padding: 18mm 16mm;
      margin: 0 auto;
      color:#111;
    }
    .docHeader{
      display:flex;
      justify-content: space-between;
      gap: 18px;
      align-items:flex-start;
    }
    .docBrand{
      display:flex;
      gap: 14px;
      align-items:flex-start;
    }
    .docLogo{
      width: 64px;
      height: 64px;
      object-fit: contain;
      display:block;
    }
    .docBrandText h1{
      margin: 0;
      font-size: 34px;
      font-weight: 800;
      line-height: 1.05;
    }
    .docTagline{
      margin-top: 6px;
      font-size: 14px;
      color:#444;
    }
    .docContact{
      margin-top: 10px;
      font-size: 14px;
      color:#222;
      line-height: 1.5;
    }
    .docBox{
      text-align:right;
      min-width: 270px;
    }
    .docTitle{
      font-size: 34px;
      font-weight: 900;
      letter-spacing: .5px;
      margin: 0 0 10px 0;
      text-transform: uppercase;
    }
    .docMeta{
      display:inline-block;
      text-align:right;
      font-size: 16px;
    }
    .metaRow{
      display:grid;
      grid-template-columns: 120px 130px;
      gap: 8px;
      align-items: baseline;
      margin: 6px 0;
    }
    .metaRow .k{ font-weight: 800; }
    .metaRow .v{ font-weight: 600; }

    .dividerGold{ height: 3px; background: var(--gold); margin: 18px 0; }

    .guestLine{
      margin: 0 0 12px 0;
      font-size: 15px;
      color:#111;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .guestLine strong{ font-weight: 800; }

    .docTable{
      width:100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 16px;
    }
    .docTable thead th{
      background: var(--gold);
      color:#000;
      text-align:left;
      padding: 12px 12px;
      font-weight: 900;
      border: 1px solid var(--gold);
      text-transform: uppercase;
    }
    .docTable tbody td{
      padding: 14px 12px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    .colQty{ width: 120px; }
    .colUnit{ width: 160px; text-align:right; }
    .colTotal{ width: 160px; text-align:right; }

    .totalsWrap{
      margin-top: 22px;
      display:flex;
      justify-content: flex-end;
    }
    .totals{
      width: 380px;
      font-size: 16px;
    }
    .totalsTopLine{ border-top: 2px solid #111; margin-bottom: 10px; }
    .tRow{ display:flex; justify-content: space-between; padding: 6px 0; }
    .tRow .label{ font-weight: 700; color:#111; }
    .tRow .value{ font-weight: 700; }
    .goldLine{ height: 3px; background: var(--gold); margin: 8px 0 10px 0; }
    .tTotal{ display:flex; justify-content: space-between; align-items: baseline; font-size: 22px; font-weight: 900; }

    .receiptInfo{
      margin-top: 18px;
      border-top: 1px solid var(--line);
      padding-top: 14px;
      font-size: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 20px;
    }
    .receiptInfo .rRow{
      display:flex; justify-content: space-between; gap: 10px;
      border-bottom: 1px dashed #e7e7e7;
      padding: 8px 0;
    }
    .receiptInfo .rRow:last-child{ border-bottom:none; }
    .receiptInfo .rk{ font-weight: 800; }
    .receiptInfo .rv{ font-weight: 700; }

    .docFooter{
      margin-top: 70px;
      border-top: 1px solid #e6e6e6;
      padding-top: 18px;
      display:flex;
      justify-content: flex-end;
      font-weight: 800;
      color:#111;
    }

    .hiddenRender{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 210mm;
      background: #fff;
    }

    /* History list */
    .historyList{ display:flex; flex-direction: column; gap: 8px; }
    .histItem{
      border:1px solid #e5e7eb; border-radius:12px; padding:10px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
      background:#fff;
    }
    .histItem .hTitle{ font-weight: 900; font-size: 13.5px; }
    .histItem .hMeta{ font-size: 12px; color:#555; margin-top: 2px; }
    .histBtns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .small{ font-size: 11.5px; color:#555; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">
        <img src="logo.png" alt="Logo" />
        <div>
          <div class="t1">Sunset Escape Billing System</div>
          <div class="t2">Quotation • Proforma Invoice • Invoice • Payment Receipt (PDF)</div>
        </div>
      </div>
      <div class="pillbar">
        <div class="pill">Address: 15/4 Wakanda road, Homagama</div>
        <div class="pill">Phone: +94 71 417 5072</div>
        <div class="pill">Email: sunset.escape24@gmail.com</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div class="card">
        <div class="cardHeader">
          <h2>Create / Edit Document</h2>
          <div class="small" id="modeLabel">Mode: New</div>
        </div>
        <div class="cardBody">
          <label>Document Type</label>
          <select id="docType">
            <option value="QUOTATION">Quotation</option>
            <option value="PROFORMA">Proforma Invoice</option>
            <option value="INVOICE">Invoice</option>
            <option value="RECEIPT">Payment Receipt</option>
          </select>

          <div class="row2">
            <div>
              <label>Document #</label>
              <input id="docNumber" placeholder="Auto" readonly />
            </div>
            <div>
              <label>Date</label>
              <input id="docDate" type="date" />
            </div>
          </div>

          <div class="row2" id="quotationExtra" style="display:none;">
            <div>
              <label>Valid Until</label>
              <input id="validUntil" type="date" />
            </div>
            <div>
              <label>Reference (optional)</label>
              <input id="reference" placeholder="e.g., Booking / Guest / Note" />
            </div>
          </div>

          <div class="row2" id="commonRefRow">
            <div>
              <label>Customer Name</label>
              <input id="customerName" placeholder="Customer name" />
            </div>
            <div>
              <label>Customer Phone</label>
              <input id="customerPhone" placeholder="Customer phone" />
            </div>
          </div>

          <!-- Receipt-only -->
          <div id="receiptFields" style="display:none;">
            <div class="row2">
              <div>
                <label>For Invoice # (optional)</label>
                <input id="forInvoiceNumber" placeholder="e.g., 000156" />
              </div>
              <div>
                <label>Date & Time (text)</label>
                <input id="receiptDateTimeText" placeholder="e.g., 26 / 12 / 2025 • 7:30 PM" />
              </div>
            </div>
            <div class="row2">
              <div>
                <label>Payment Method</label>
                <input id="paymentMethod" placeholder="Cash / Bank Transfer / Card" />
              </div>
              <div>
                <label>Reference No (Txn/Slip)</label>
                <input id="paymentRef" placeholder="Txn / Slip number" />
              </div>
            </div>
            <label>Receipt Amount</label>
            <input id="receiptAmount" type="number" min="0" step="0.01" placeholder="Amount received" />
          </div>

          <!-- Items -->
          <div id="itemsSection">
            <label>Add Line Item</label>
            <div class="row3">
              <input id="itemDesc" placeholder="Description" />
              <input id="itemQty" type="number" min="0" step="1" placeholder="Qty" />
              <input id="itemUnit" type="number" min="0" step="0.01" placeholder="Unit Price" />
            </div>
            <div class="btnRow" style="margin-top:10px;">
              <button class="secondary" type="button" id="addItemBtn">Add Item</button>
              <button class="secondary" type="button" id="clearItemsBtn">Clear Items</button>
            </div>

            <table class="items" id="itemsTable">
              <thead>
                <tr>
                  <th>Description</th>
                  <th class="num">Qty</th>
                  <th class="num">Unit</th>
                  <th class="num">Total</th>
                  <th class="actions"></th>
                </tr>
              </thead>
              <tbody id="itemsTbody"></tbody>
            </table>

            <div class="row2">
              <div>
                <label>Advanced (optional)</label>
                <input id="advanced" type="number" min="0" step="0.01" value="0" />
              </div>
              <div>
                <label>Currency</label>
                <select id="currency">
                  <option value="LKR">LKR</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </div>
            </div>

            <div class="hint">
              Invoices/Quotations/Proforma are bills for the customer to pay.
              Payment Receipt is issued separately after payment.
            </div>
          </div>

          <div class="btnRow">
            <button type="button" id="newBtn" class="secondary">New</button>
            <button type="button" id="saveBtn">Save</button>
            <button type="button" id="downloadBtn">Download PDF</button>
          </div>

          <div class="btnRow">
            <button type="button" id="deleteBtn" class="danger" disabled>Delete</button>
            <button type="button" id="resetDataBtn" class="secondary">Reset All Data</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: PREVIEW + HISTORY -->
      <div class="card">
        <div class="cardHeader">
          <h2>Preview & History</h2>
          <div class="small" id="countLabel"></div>
        </div>
        <div class="previewWrap">
          <div class="hint">Preview updates automatically. Use <b>Download PDF</b> for the final document.</div>
          <div style="height:10px;"></div>

          <div class="card" style="box-shadow:none;">
            <div class="cardHeader" style="border-bottom:1px solid #e5e7eb;">
              <h2>Live Preview</h2>
              <div class="small" id="previewType"></div>
            </div>
            <div class="cardBody" style="padding: 0;">
              <div id="previewContainer" style="transform: scale(.62); transform-origin: top left; width: 161%; background:#fff; border-radius: 14px;">
                <!-- Rendered document will appear here -->
              </div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="card" style="box-shadow:none;">
            <div class="cardHeader" style="border-bottom:1px solid #e5e7eb;">
              <h2>Saved Documents</h2>
              <div class="small">Click to open, download, or delete</div>
            </div>
            <div class="cardBody">
              <div class="historyList" id="historyList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- hidden render target for PDF -->
    <div class="hiddenRender" id="pdfMount"></div>
  </div>

  <script>
    /***********************
     * Storage + Utilities *
     ***********************/
    const STORAGE_KEY = "sunset_escape_docs_v1";
    const COUNTER_KEY = "sunset_escape_counters_v1";

    const BRAND = {
      name: "Sunset Escape",
      tagline: "Beyond the ordinary, into luxury",
      phone: "+94 71 417 5072",
      locationLine: "Sunset Escape Homagama",
      logoSrc: "logo.png"
    };

    const TYPE_LABEL = {
      QUOTATION: "QUOTATION",
      PROFORMA: "PROFORMA INVOICE",
      INVOICE: "INVOICE",
      RECEIPT: "PAYMENT RECEIPT"
    };

    const TYPE_META_LABEL_1 = {
      QUOTATION: "Quotation #",
      PROFORMA: "Proforma #",
      INVOICE: "Invoice #",
      RECEIPT: "Receipt #"
    };

    const pad6 = (n) => String(n).padStart(6, "0");

    const todayISO = () => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };

    const money = (n) => {
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { maximumFractionDigits: 2 });
    };

    const sumItems = (items) => items.reduce((acc, it) => acc + (Number(it.qty||0) * Number(it.unit||0)), 0);

    const loadDocs = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    };

    const saveDocs = (docs) => localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));

    const loadCounters = () => {
      try {
        return JSON.parse(localStorage.getItem(COUNTER_KEY)) || { QUOTATION: 0, PROFORMA: 0, INVOICE: 0, RECEIPT: 0 };
      } catch {
        return { QUOTATION: 0, PROFORMA: 0, INVOICE: 0, RECEIPT: 0 };
      }
    };

    const saveCounters = (counters) => localStorage.setItem(COUNTER_KEY, JSON.stringify(counters));

    const nextNumberForType = (type) => {
      const counters = loadCounters();
      counters[type] = (counters[type] || 0) + 1;
      saveCounters(counters);
      return pad6(counters[type]);
    };

    const formatDateDDMMYYYY = (iso) => {
      if (!iso) return "";
      const [y,m,d] = iso.split("-");
      return `${d} / ${m} / ${y}`;
    };

    /***********************
     * UI Elements         *
     ***********************/
    const el = (id) => document.getElementById(id);

    const docType = el("docType");
    const docNumber = el("docNumber");
    const docDate = el("docDate");
    const validUntil = el("validUntil");
    const reference = el("reference");
    const customerName = el("customerName");
    const customerPhone = el("customerPhone");

    const receiptFields = el("receiptFields");
    const forInvoiceNumber = el("forInvoiceNumber");
    const receiptDateTimeText = el("receiptDateTimeText");
    const paymentMethod = el("paymentMethod");
    const paymentRef = el("paymentRef");
    const receiptAmount = el("receiptAmount");

    const itemsSection = el("itemsSection");
    const itemDesc = el("itemDesc");
    const itemQty = el("itemQty");
    const itemUnit = el("itemUnit");
    const addItemBtn = el("addItemBtn");
    const clearItemsBtn = el("clearItemsBtn");
    const itemsTbody = el("itemsTbody");
    const advanced = el("advanced");
    const currency = el("currency");

    const newBtn = el("newBtn");
    const saveBtn = el("saveBtn");
    const downloadBtn = el("downloadBtn");
    const deleteBtn = el("deleteBtn");
    const resetDataBtn = el("resetDataBtn");

    const previewContainer = el("previewContainer");
    const pdfMount = el("pdfMount");
    const historyList = el("historyList");
    const modeLabel = el("modeLabel");
    const countLabel = el("countLabel");
    const previewType = el("previewType");

    const quotationExtra = el("quotationExtra");
    const commonRefRow = el("commonRefRow");

    /***********************
     * App State           *
     ***********************/
    let items = [];
    let editingId = null;

    function setMode(isEdit){
      modeLabel.textContent = isEdit ? "Mode: Editing" : "Mode: New";
      deleteBtn.disabled = !isEdit;
    }

    function newDocument(){
      editingId = null;
      setMode(false);

      const type = docType.value;
      docNumber.value = nextNumberForType(type);
      docDate.value = todayISO();

      // defaults
      validUntil.value = "";
      reference.value = "";
      customerName.value = "";
      customerPhone.value = "";

      forInvoiceNumber.value = "";
      receiptDateTimeText.value = "";
      paymentMethod.value = "";
      paymentRef.value = "";
      receiptAmount.value = "";

      advanced.value = "0";
      currency.value = "LKR";

      items = [];
      renderItems();
      handleTypeUI();
      renderPreview();
    }

    function handleTypeUI(){
      const type = docType.value;

      // show valid until only for quotation
      quotationExtra.style.display = (type === "QUOTATION") ? "grid" : "none";
      commonRefRow.style.display = "grid";

      // receipt uses receipt fields; items optional but we keep available
      receiptFields.style.display = (type === "RECEIPT") ? "block" : "none";

      // For receipt: advanced isn't meaningful; keep items optional
      // Keep items section visible but hide advanced line in totals by logic later.
      itemsSection.style.display = "block";
      previewType.textContent = TYPE_LABEL[type];

      // Ensure number reflects type if user changes type mid-edit
      if (!editingId){
        docNumber.value = nextNumberForType(type);
      }
    }

    function addItem(){
      const desc = (itemDesc.value || "").trim();
      const qty = Number(itemQty.value || 0);
      const unit = Number(itemUnit.value || 0);

      if (!desc) { alert("Please enter item description."); return; }
      if (qty <= 0) { alert("Quantity must be greater than 0."); return; }
      if (unit < 0) { alert("Unit price cannot be negative."); return; }

      items.push({ desc, qty, unit });
      itemDesc.value = "";
      itemQty.value = "";
      itemUnit.value = "";
      renderItems();
      renderPreview();
    }

    function removeItem(idx){
      items.splice(idx, 1);
      renderItems();
      renderPreview();
    }

    function clearItems(){
      if (!confirm("Clear all line items?")) return;
      items = [];
      renderItems();
      renderPreview();
    }

    function renderItems(){
      itemsTbody.innerHTML = "";
      items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        const total = Number(it.qty) * Number(it.unit);
        tr.innerHTML = `
          <td>${escapeHtml(it.desc)}</td>
          <td class="num">${money(it.qty)}</td>
          <td class="num">${money(it.unit)}</td>
          <td class="num">${money(total)}</td>
          <td class="actions"><button class="miniBtn" type="button" title="Remove" data-idx="${idx}">×</button></td>
        `;
        itemsTbody.appendChild(tr);
      });

      itemsTbody.querySelectorAll("button[data-idx]").forEach(btn => {
        btn.addEventListener("click", () => removeItem(Number(btn.dataset.idx)));
      });
    }

    function getFormDoc(){
      const type = docType.value;

      const doc = {
        id: editingId || crypto.randomUUID(),
        type,
        number: docNumber.value.trim(),
        dateISO: docDate.value,
        customerName: customerName.value.trim(),
        customerPhone: customerPhone.value.trim(),
        reference: reference.value.trim(),
        validUntilISO: validUntil.value,
        currency: currency.value,
        items: items.map(x => ({...x})),
        advanced: Number(advanced.value || 0),

        // receipt fields
        forInvoiceNumber: forInvoiceNumber.value.trim(),
        receiptDateTimeText: receiptDateTimeText.value.trim(),
        paymentMethod: paymentMethod.value.trim(),
        paymentRef: paymentRef.value.trim(),
        receiptAmount: Number(receiptAmount.value || 0),

        createdAt: editingId ? undefined : Date.now(),
        updatedAt: Date.now()
      };

      return doc;
    }

    function validateDoc(doc){
      if (!doc.number) return "Document number is missing.";
      if (!doc.dateISO) return "Date is required.";

      if (!doc.customerName) return "Customer name is required.";
      if (!doc.customerPhone) return "Customer phone is required.";

      if (doc.type === "QUOTATION" && doc.validUntilISO && doc.validUntilISO < doc.dateISO){
        return "Valid Until cannot be earlier than Date.";
      }

      if (doc.type !== "RECEIPT"){
        if (doc.items.length === 0) return "Please add at least one line item.";
      } else {
        if (doc.receiptAmount <= 0) return "Receipt amount must be greater than 0.";
        if (!doc.paymentMethod) return "Payment method is required for receipt.";
      }

      return null;
    }

    function saveCurrent(){
      const docs = loadDocs();
      const doc = getFormDoc();
      const err = validateDoc(doc);
      if (err) { alert(err); return; }

      const existingIdx = docs.findIndex(d => d.id === doc.id);
      if (existingIdx >= 0){
        docs[existingIdx] = { ...docs[existingIdx], ...doc, updatedAt: Date.now() };
      } else {
        docs.unshift({ ...doc, createdAt: Date.now() });
      }

      saveDocs(docs);
      editingId = doc.id;
      setMode(true);
      renderHistory();
      renderPreview();
      alert("Saved.");
    }

    function loadForEdit(id){
      const docs = loadDocs();
      const doc = docs.find(d => d.id === id);
      if (!doc) return;

      editingId = doc.id;
      setMode(true);

      docType.value = doc.type;
      docNumber.value = doc.number;
      docDate.value = doc.dateISO || todayISO();

      validUntil.value = doc.validUntilISO || "";
      reference.value = doc.reference || "";
      customerName.value = doc.customerName || "";
      customerPhone.value = doc.customerPhone || "";

      currency.value = doc.currency || "LKR";
      advanced.value = String(doc.advanced || 0);

      forInvoiceNumber.value = doc.forInvoiceNumber || "";
      receiptDateTimeText.value = doc.receiptDateTimeText || "";
      paymentMethod.value = doc.paymentMethod || "";
      paymentRef.value = doc.paymentRef || "";
      receiptAmount.value = String(doc.receiptAmount || 0);

      items = (doc.items || []).map(x => ({...x}));
      renderItems();
      handleTypeUI();
      renderPreview();
    }

    function deleteCurrent(){
      if (!editingId) return;
      if (!confirm("Delete this document?")) return;

      const docs = loadDocs().filter(d => d.id !== editingId);
      saveDocs(docs);

      editingId = null;
      setMode(false);
      renderHistory();
      newDocument();
    }

    function resetAllData(){
      if (!confirm("This will delete ALL saved documents and reset numbering. Continue?")) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(COUNTER_KEY);
      items = [];
      editingId = null;
      setMode(false);
      renderHistory();
      newDocument();
    }

    /***********************
     * Template Rendering  *
     ***********************/
    function renderDocHTML(doc){
      const typeTitle = TYPE_LABEL[doc.type];
      const metaLabel1 = TYPE_META_LABEL_1[doc.type];
      const dateText = formatDateDDMMYYYY(doc.dateISO);

      // Items and totals
      const subtotal = sumItems(doc.items || []);
      const adv = Number(doc.advanced || 0);
      const total = subtotal - adv;

      const currencyLabel = doc.currency || "LKR";
      const showTotals = doc.type !== "RECEIPT";

      const col1 = (doc.type === "RECEIPT") ? "DESCRIPTION" : "BOOKING DETAILS";
      const refText = (doc.type === "RECEIPT")
        ? `For Invoice # ${doc.forInvoiceNumber || "[Optional]"}`
        : (doc.reference || "[Optional]");

      const validUntilRow = (doc.type === "QUOTATION" && doc.validUntilISO)
        ? `<div class="metaRow"><div class="k">Valid Until</div><div class="v">${formatDateDDMMYYYY(doc.validUntilISO)}</div></div>`
        : "";

      const itemsRows = (doc.items || []).map(it => {
        const t = Number(it.qty||0) * Number(it.unit||0);
        return `
          <tr>
            <td>${escapeHtml(it.desc)}</td>
            <td class="colQty">${money(it.qty)}</td>
            <td class="colUnit">${money(it.unit)}</td>
            <td class="colTotal">${money(t)}</td>
          </tr>`;
      }).join("");

      const receiptBlock = (doc.type === "RECEIPT") ? `
        <div class="receiptInfo">
          <div class="rRow"><div class="rk">Received From</div><div class="rv">${escapeHtml(doc.customerName || "")}</div></div>
          <div class="rRow"><div class="rk">Receipt Amount</div><div class="rv">${currencyLabel} ${money(doc.receiptAmount)}</div></div>
          <div class="rRow"><div class="rk">Payment Method</div><div class="rv">${escapeHtml(doc.paymentMethod || "")}</div></div>
          <div class="rRow"><div class="rk">Reference No</div><div class="rv">${escapeHtml(doc.paymentRef || "[Txn/Slip No]")}</div></div>
          <div class="rRow"><div class="rk">For Invoice #</div><div class="rv">${escapeHtml(doc.forInvoiceNumber || "[Optional]")}</div></div>
          <div class="rRow"><div class="rk">Date & Time</div><div class="rv">${escapeHtml(doc.receiptDateTimeText || dateText)}</div></div>
        </div>` : "";

      const totalsBlock = showTotals ? `
        <div class="totalsWrap">
          <div class="totals">
            <div class="totalsTopLine"></div>

            <div class="tRow">
              <div class="label">Sub Total</div>
              <div class="value">${currencyLabel} ${money(subtotal)}</div>
            </div>

            <div class="tRow">
              <div class="label">Advanced</div>
              <div class="value">${currencyLabel} ${money(adv)}</div>
            </div>

            <div class="goldLine"></div>

            <div class="tTotal">
              <div>Total</div>
              <div>${currencyLabel} ${money(total)}</div>
            </div>
          </div>
        </div>` : "";

      const footer = (doc.type === "RECEIPT")
        ? "Payment received with thanks."
        : "Thank you for choosing Sunset Escape.";

      return `
        <div class="pageA4">
          <div class="docHeader">
            <div class="docBrand">
              <img class="docLogo" src="${BRAND.logoSrc}" alt="Sunset Escape Logo" />
              <div class="docBrandText">
                <h1>${BRAND.name}</h1>
                <div class="docTagline">${BRAND.tagline}</div>
                <div class="docContact">
                  ${BRAND.phone}<br />
                  ${BRAND.locationLine}
                </div>
              </div>
            </div>

            <div class="docBox">
              <div class="docTitle">${typeTitle}</div>
              <div class="docMeta">
                <div class="metaRow">
                  <div class="k">${metaLabel1}</div>
                  <div class="v">${escapeHtml(doc.number)}</div>
                </div>
                <div class="metaRow">
                  <div class="k">Date</div>
                  <div class="v">${dateText}</div>
                </div>
                ${validUntilRow}
              </div>
            </div>
          </div>

          <div class="dividerGold"></div>

          <div class="guestLine">
            <div><strong>Customer:</strong> ${escapeHtml(doc.customerName || "")}</div>
            <div><strong>Phone:</strong> ${escapeHtml(doc.customerPhone || "")}</div>
            <div><strong>Reference:</strong> ${escapeHtml(refText)}</div>
          </div>

          <table class="docTable">
            <thead>
              <tr>
                <th>${col1}</th>
                <th class="colQty">QUANTITY</th>
                <th class="colUnit">UNIT PRICE</th>
                <th class="colTotal">TOTAL</th>
              </tr>
            </thead>
            <tbody>
              ${itemsRows || `
                <tr>
                  <td>[No line items]</td><td class="colQty">0</td><td class="colUnit">0</td><td class="colTotal">0</td>
                </tr>`
              }
            </tbody>
          </table>

          ${totalsBlock}
          ${receiptBlock}

          <div class="docFooter">${footer}</div>
        </div>
      `;
    }

    function renderPreview(){
      const doc = getFormDoc();
      // avoid blocking preview with validation errors; show whatever exists
      previewContainer.innerHTML = renderDocHTML(doc);
    }

    async function downloadPDFForCurrent(){
      const doc = getFormDoc();
      const err = validateDoc(doc);
      if (err) { alert(err); return; }

      // render into pdf mount (not scaled)
      pdfMount.innerHTML = renderDocHTML(doc);

      const filename = `${doc.type}-${doc.number}.pdf`;
      const opt = {
        margin: 0,
        filename,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      try{
        await html2pdf().set(opt).from(pdfMount.firstElementChild).save();
      } finally {
        pdfMount.innerHTML = "";
      }
    }

    /***********************
     * History Rendering   *
     ***********************/
    function renderHistory(){
      const docs = loadDocs();
      countLabel.textContent = `${docs.length} saved document(s)`;
      historyList.innerHTML = "";

      if (docs.length === 0){
        historyList.innerHTML = `<div class="hint">No saved documents yet.</div>`;
        return;
      }

      docs.slice(0, 50).forEach(d => {
        const subtotal = sumItems(d.items || []);
        const total = (d.type === "RECEIPT")
          ? Number(d.receiptAmount || 0)
          : (subtotal - Number(d.advanced || 0));

        const card = document.createElement("div");
        card.className = "histItem";

        const title = `${TYPE_LABEL[d.type]} #${d.number}`;
        const meta = `${formatDateDDMMYYYY(d.dateISO)} • ${d.customerName} • ${d.currency || "LKR"} ${money(total)}`;

        card.innerHTML = `
          <div>
            <div class="hTitle">${escapeHtml(title)}</div>
            <div class="hMeta">${escapeHtml(meta)}</div>
          </div>
          <div class="histBtns">
            <button class="miniBtn" data-open="${d.id}">Open</button>
            <button class="miniBtn" data-pdf="${d.id}">PDF</button>
          </div>
        `;
        historyList.appendChild(card);
      });

      historyList.querySelectorAll("button[data-open]").forEach(b => {
        b.addEventListener("click", () => loadForEdit(b.dataset.open));
      });

      historyList.querySelectorAll("button[data-pdf]").forEach(b => {
        b.addEventListener("click", async () => {
          const docs = loadDocs();
          const d = docs.find(x => x.id === b.dataset.pdf);
          if (!d) return;

          // render & download
          pdfMount.innerHTML = renderDocHTML(d);
          const filename = `${d.type}-${d.number}.pdf`;
          const opt = {
            margin: 0,
            filename,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
          };
          try{
            await html2pdf().set(opt).from(pdfMount.firstElementChild).save();
          } finally {
            pdfMount.innerHTML = "";
          }
        });
      });
    }

    /***********************
     * Safety: HTML escape *
     ***********************/
    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     * Events              *
     ***********************/
    docType.addEventListener("change", () => { handleTypeUI(); renderPreview(); });
    [docDate, validUntil, reference, customerName, customerPhone, advanced, currency,
     forInvoiceNumber, receiptDateTimeText, paymentMethod, paymentRef, receiptAmount
    ].forEach(x => x.addEventListener("input", renderPreview));

    addItemBtn.addEventListener("click", addItem);
    clearItemsBtn.addEventListener("click", clearItems);

    newBtn.addEventListener("click", newDocument);
    saveBtn.addEventListener("click", saveCurrent);
    downloadBtn.addEventListener("click", downloadPDFForCurrent);
    deleteBtn.addEventListener("click", deleteCurrent);
    resetDataBtn.addEventListener("click", resetAllData);

    /***********************
     * Init                *
     ***********************/
    function init(){
      docDate.value = todayISO();
      handleTypeUI();
      renderHistory();
      // Initialize new doc with a number
      newDocument();
    }

    init();
  </script>
</body>
</html>
