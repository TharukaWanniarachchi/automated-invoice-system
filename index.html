<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>Automated Invoice Generator - Sunset Escape</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f4f4f4;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      padding-left: max(20px, env(safe-area-inset-left));
      padding-right: max(20px, env(safe-area-inset-right));
      color: #000000;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 30px;
    }

    /* INPUT PANEL */
    .input-panel {
      width: 400px;
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
      height: fit-content;
      position: sticky;
      top: 20px;
      min-width: 320px;
    }

    .input-panel h2 {
      color: #E1C571;
      margin-bottom: 20px;
      font-size: 24px;
      border-bottom: 2px solid #E1C571;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
      min-height: 44px;
      box-sizing: border-box;
      background: #ffffff;
      -webkit-tap-highlight-color: rgba(225, 197, 113, 0.3);
      touch-action: manipulation;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: #E1C571;
      outline: none;
      box-shadow: 0 0 0 3px rgba(225, 197, 113, 0.2);
    }

    .items-section {
      border: 2px solid #E1C571;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .items-section h3 {
      color: #E1C571;
      margin-bottom: 15px;
    }

    .item-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }

    .item-row input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-height: 40px;
      -webkit-appearance: none;
      appearance: none;
      box-sizing: border-box;
    }

    .item-row .desc-input {
      flex: 2;
      min-width: 120px;
    }

    .item-row .qty-input,
    .item-row .price-input {
      flex: 1;
      max-width: 90px;
      min-width: 60px;
    }

    .item-row button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      min-height: 40px;
      min-width: 40px;
      font-size: 16px;
      font-weight: bold;
      -webkit-tap-highlight-color: rgba(220, 53, 69, 0.3);
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .item-row button:active {
      background: #c82333;
    }

    .add-item-btn {
      background: #E1C571;
      color: black;
      border: none;
      padding: 14px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      font-size: 16px;
      min-height: 48px;
      transition: background-color 0.2s ease;
      -webkit-tap-highlight-color: rgba(225, 197, 113, 0.3);
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .add-item-btn:hover,
    .add-item-btn:active {
      background: #d4b560;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-direction: column;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      min-height: 48px;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn-primary {
      background: #E1C571;
      color: black;
    }

    .btn-primary:active {
      background: #d4b560;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:active {
      background: #5a6268;
    }

    /* INVOICE PREVIEW */
    .invoice-preview {
      flex: 1;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      padding: 40px 50px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
    }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
      border-bottom: 3px solid #E1C571;
      padding-bottom: 15px;
    }

    .brand-block {
      max-width: 60%;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 80px;
      height: auto;
    }

    .brand-name {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .brand-tagline {
      font-size: 13px;
      letter-spacing: 0.5px;
      color: #333333;
      margin-bottom: 8px;
    }

    .brand-contact {
      font-size: 13px;
      color: #333333;
      line-height: 1.4;
    }

    .brand-contact span {
      display: block;
    }

    .invoice-block {
      text-align: right;
      font-size: 13px;
      color: #000000;
    }

    .invoice-title {
      font-size: 26px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    /* PAID BADGE */
    .status-badge {
      display: none;
      margin-top: 6px;
      font-weight: 800;
      font-size: 13px;
      letter-spacing: 0.5px;
      color: #1b5e20;
      text-transform: uppercase;
    }

    /* Receipt reference line */
    .receipt-ref {
      display: none;
      margin-top: 10px;
      font-size: 13px;
      color: #000000;
    }

    .meta-table {
      margin-left: auto;
      border-collapse: collapse;
    }

    .meta-table td {
      padding: 2px 0 2px 10px;
      font-size: 13px;
    }

    .meta-label {
      font-weight: 600;
      text-align: right;
      white-space: nowrap;
    }

    /* TABLE */
    .table-wrapper {
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead tr {
      background: #E1C571;
      color: #000000;
    }

    thead th {
      text-transform: uppercase;
      font-size: 12px;
      font-weight: 600;
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #dddddd;
    }

    tbody td {
      padding: 10px 8px;
      border-bottom: 1px solid #eeeeee;
      vertical-align: top;
    }

    .col-desc {
      width: 50%;
    }

    .col-qty {
      width: 15%;
    }

    .col-unit {
      width: 15%;
    }

    .col-total {
      width: 20%;
    }

    .amount {
      text-align: right;
      white-space: nowrap;
    }

    /* SUMMARY */
    .summary-block {
      max-width: 280px;
      margin-left: auto;
      margin-top: 18px;
      border-top: 2px solid #000000;
      padding-top: 8px;
      font-size: 14px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }

    .summary-label {
      font-weight: 500;
    }

    .summary-total {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 2px solid #E1C571;
      font-weight: 700;
      font-size: 15px;
    }

    /* FOOTER */
    .footer {
      margin-top: 35px;
      font-size: 12px;
      color: #333333;
      border-top: 1px solid #dddddd;
      padding-top: 10px;
      text-align: right;
    }

    .footer strong {
      color: #000000;
    }

    /* PRINT */
    @media print {
      @page {
        size: 900px 1200px;
        margin: 0;
      }

      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      html {
        width: 900px !important;
        height: auto !important;
      }

      body {
        background: #ffffff !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 900px !important;
      }

      .page {
        width: 900px !important;
        height: auto !important;
        margin: 0 auto !important;
        padding: 40px 50px !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        page-break-inside: avoid !important;
      }

      .header {
        border-bottom: 3px solid #E1C571 !important;
        width: 100% !important;
        margin-bottom: 30px !important;
        padding-bottom: 15px !important;
      }

      .brand-logo {
        width: 80px !important;
        height: auto !important;
      }

      table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 14px !important;
      }

      thead tr {
        background: #E1C571 !important;
        color: #000000 !important;
      }

      thead th {
        background: #E1C571 !important;
        color: #000000 !important;
        padding: 10px 8px !important;
      }

      tbody td {
        padding: 10px 8px !important;
        border-bottom: 1px solid #eeeeee !important;
      }

      .summary-block {
        max-width: 280px !important;
        margin-left: auto !important;
        margin-top: 18px !important;
        border-top: 2px solid #000000 !important;
        padding-top: 8px !important;
      }

      .summary-total {
        border-top: 2px solid #E1C571 !important;
        margin-top: 6px !important;
        padding-top: 6px !important;
      }

      .footer {
        margin-top: 35px !important;
        border-top: 1px solid #dddddd !important;
        padding-top: 10px !important;
      }

      .invoice-preview {
        width: 900px !important;
        margin: 0 auto !important;
      }

      .container {
        display: block !important;
        width: 900px !important;
        margin: 0 auto !important;
      }

      body,
      html {
        overflow: visible !important;
      }

      body * {
        overflow: visible !important;
        transform: none !important;
      }

      .page * {
        overflow: visible !important;
        transform: none !important;
      }

      .page,
      .page * {
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      body {
        position: static !important;
      }

      * {
        position: static !important;
      }

      html,
      body {
        padding: 0 !important;
        margin: 0 !important;
        overflow: visible !important;
        transform: scale(1) !important;
        zoom: 1 !important;
      }

      .input-panel {
        display: none !important;
        visibility: hidden !important;
      }

      .container {
        display: block !important;
        width: 900px !important;
        margin: 0 auto !important;
      }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
        gap: 20px;
      }

      .input-panel {
        width: 100%;
        position: relative;
        top: 0;
        max-width: 600px;
        margin: 0 auto;
      }
    }

    /* iPad specific */
    @media (min-width: 768px) and (max-width: 1024px) {
      .container {
        max-width: 100%;
        padding: 0 20px;
      }

      .input-panel {
        max-width: 700px;
      }

      .page {
        max-width: 800px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .container {
        gap: 15px;
      }

      .input-panel {
        padding: 20px;
        border-radius: 6px;
      }

      .input-panel h2 {
        font-size: 22px;
        margin-bottom: 15px;
      }

      .page {
        padding: 30px 25px;
        border-radius: 6px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .brand-block {
        max-width: 100%;
      }

      .invoice-block {
        text-align: left;
      }

      .meta-table {
        margin-left: 0;
      }

      .brand-logo {
        width: 60px;
      }

      .brand-name {
        font-size: 24px;
      }

      table {
        font-size: 13px;
      }

      thead th {
        padding: 8px 6px;
        font-size: 11px;
      }

      tbody td {
        padding: 8px 6px;
      }

      .action-buttons {
        flex-direction: row;
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .input-panel {
        padding: 15px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .items-section {
        padding: 15px;
      }

      .item-row {
        flex-direction: column;
        gap: 5px;
      }

      .item-row input {
        min-height: 44px;
      }

      .add-item-btn {
        min-height: 44px;
      }

      .btn {
        min-height: 44px;
      }

      .page {
        padding: 20px 15px;
      }

      .header {
        flex-direction: column;
        gap: 10px;
      }

      .brand-block {
        justify-content: center;
        text-align: center;
      }

      .invoice-block {
        text-align: center;
      }

      .meta-table {
        margin: 0 auto;
      }

      .brand-logo {
        width: 50px;
      }

      .brand-name {
        font-size: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- INPUT PANEL -->
    <div class="input-panel">
      <h2>Invoice Generator</h2>

      <!-- Document Type -->
      <div class="form-group">
        <label for="documentType">Document Type</label>
        <select id="documentType" onchange="updateInvoice()">
          <option value="invoice">Invoice (Final)</option>
          <option value="advance">Advance Payment Receipt</option>
          <option value="proforma">Proforma Invoice / Quotation</option>
          <option value="receipt">Payment Receipt</option>
        </select>
      </div>

      <!-- Reference Number -->
      <div class="form-group">
        <label for="invoiceNumber">Reference Number</label>
        <input type="text" id="invoiceNumber" value="000144" onchange="updateInvoice()">
      </div>

      <!-- Date -->
      <div class="form-group">
        <label for="invoiceDate">Date</label>
        <input type="date" id="invoiceDate" value="2025-11-09" onchange="updateInvoice()">
      </div>

      <!-- Items Section -->
      <div class="items-section">
        <h3>Booking Items</h3>
        <div id="itemsContainer"></div>
        <button class="add-item-btn" onclick="addNewItem()">+ Add Item</button>
      </div>

      <!-- Amount paid -->
      <div class="form-group">
        <label for="advancedPayment" id="amountPaidLabel">Advanced / Amount Paid (LKR)</label>
        <input type="number" id="advancedPayment" value="42000" onchange="updateInvoice()">
      </div>

      <!-- Payment method + reference (shown for advance & receipt only) -->
      <div class="form-group" id="paymentMethodGroup" style="display:none;">
        <label for="paymentMethod">Payment Method</label>
        <select id="paymentMethod" onchange="updateInvoice()">
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Cash">Cash</option>
          <option value="Online Payment">Online Payment</option>
        </select>
      </div>

      <div class="form-group" id="transactionRefGroup" style="display:none;">
        <label for="transactionRef">Transaction Reference</label>
        <input type="text" id="transactionRef" placeholder="Bank slip / Ref No" onchange="updateInvoice()">
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="customPrint()">Print</button>
        <button class="btn btn-secondary" onclick="downloadPDF()">Download PDF</button>
      </div>
    </div>

    <!-- INVOICE PREVIEW -->
    <div class="invoice-preview">
      <div class="page">
        <!-- HEADER -->
        <div class="header">
          <div class="brand-block">
            <img src="logo.png" alt="Sunset Escape Logo" class="brand-logo" />
            <div>
              <div class="brand-name">Sunset Escape</div>
              <div class="brand-tagline">Beyond the ordinary, into luxury</div>
              <div class="brand-contact">
                <span>+94 71 417 5072</span>
                <span>Sunset Escape Homagama</span>
              </div>
            </div>
          </div>

          <div class="invoice-block">
            <div class="invoice-title" id="documentTitle">Invoice</div>

            <!-- STATUS: PAID (Receipt mode) -->
            <div class="status-badge" id="paymentStatus">STATUS: PAID</div>

            <table class="meta-table">
              <tr>
                <td class="meta-label" id="metaLabel">Invoice #</td>
                <td id="displayInvoiceNumber">000144</td>
              </tr>
              <tr>
                <td class="meta-label">Date</td>
                <td id="displayInvoiceDate">09 / 11 / 2025</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Receipt reference line (Receipt mode) -->
        <div class="receipt-ref" id="receiptRef">
          Received against Invoice No: <strong id="receiptInvoiceRef"></strong>
          <span id="paymentMetaInline" style="display:block;margin-top:4px;"></span>
        </div>

        <!-- BOOKING TABLE -->
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th class="col-desc">Booking Details</th>
                <th class="col-qty">Quantity</th>
                <th class="col-unit">Unit Price</th>
                <th class="col-total">Total</th>
              </tr>
            </thead>
            <tbody id="invoiceItemsTable"></tbody>
          </table>
        </div>

        <!-- SUMMARY -->
        <div class="summary-block">
          <div class="summary-row" id="summaryRow1">
            <span class="summary-label" id="summaryLabel1">Sub Total</span>
            <span id="subTotal">0</span>
          </div>
          <div class="summary-row" id="summaryRow2">
            <span class="summary-label" id="summaryLabel2">Advanced</span>
            <span id="advancedAmount">0</span>
          </div>
          <div class="summary-row summary-total" id="summaryRow3">
            <span class="summary-label" id="summaryLabel3">Total</span>
            <span id="totalAmount">0</span>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
          <strong>Thank you for choosing Sunset Escape.</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- html2pdf.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Helper function to get today's date in YYYY-MM-DD format
    function getTodayDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Helper function to get the next invoice number from localStorage
    function getNextInvoiceNumber() {
      const STORAGE_KEY = 'sunsetEscapeLastInvoiceNumber';
      let lastNumber = parseInt(localStorage.getItem(STORAGE_KEY) || '158', 10);
      return String(lastNumber).padStart(6, '0');
    }

    // Helper function to save and increment the invoice number
    function saveAndIncrementInvoiceNumber(currentNumber) {
      const STORAGE_KEY = 'sunsetEscapeLastInvoiceNumber';
      const numValue = parseInt(currentNumber, 10);
      if (!isNaN(numValue)) {
        localStorage.setItem(STORAGE_KEY, String(numValue + 1));
      }
    }

    // Invoice data structure
    let invoiceData = {
      documentType: 'invoice', // 'invoice' | 'advance' | 'proforma' | 'receipt'
      invoiceNumber: getNextInvoiceNumber(),
      date: getTodayDate(),
      items: [],
      advancedPayment: 0,
      paymentMethod: 'Bank Transfer',
      transactionRef: ''
    };

    function initializeForm() {
      document.getElementById('documentType').value = invoiceData.documentType;
      document.getElementById('invoiceNumber').value = invoiceData.invoiceNumber;
      document.getElementById('invoiceDate').value = invoiceData.date;
      document.getElementById('advancedPayment').value = invoiceData.advancedPayment || 0;

      document.getElementById('paymentMethod').value = invoiceData.paymentMethod;
      document.getElementById('transactionRef').value = invoiceData.transactionRef;

      // Add input event listeners for real-time validation
      document.getElementById('advancedPayment').addEventListener('input', function(e) {
        if (e.target.value < 0) e.target.value = 0;
      });

      renderItems();
      updateInvoice();
    }

    function renderItems() {
      const container = document.getElementById('itemsContainer');
      container.innerHTML = '';

      invoiceData.items.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item-row';
        itemDiv.innerHTML = `
          <input type="text" class="desc-input" placeholder="Description" value="${escapeHtml(item.description)}"
                 onchange="updateItem(${index}, 'description', this.value)">
          <input type="number" class="qty-input" placeholder="Qty" value="${item.quantity}" min="1"
                 onchange="updateItem(${index}, 'quantity', parseFloat(this.value))">
          <input type="number" class="price-input" placeholder="Price" value="${item.unitPrice}" min="0"
                 onchange="updateItem(${index}, 'unitPrice', parseFloat(this.value))">
          <button onclick="removeItem(${index})">Ã—</button>
        `;
        container.appendChild(itemDiv);
      });
    }

    function escapeHtml(str) {
      return (str ?? '').toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function updateItem(index, field, value) {
      if (field === 'quantity' || field === 'unitPrice') {
        // Validate numeric input
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue < 0) {
          value = 0;
        } else {
          value = numValue;
        }
      }
      invoiceData.items[index][field] = value;
      updateInvoice();
    }

    function addNewItem() {
      invoiceData.items.push({ description: '', quantity: 1, unitPrice: 0 });
      renderItems();
      updateInvoice();
    }

    function removeItem(index) {
      invoiceData.items.splice(index, 1);
      renderItems();
      updateInvoice();
    }

    function formatCurrency(amount) {
      if (isNaN(amount)) return '0';
      return amount.toLocaleString();
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      return `${day} / ${month} / ${year}`;
    }

    function getDocumentTitle(type) {
      switch (type) {
        case 'advance':
          return 'Advance Payment Receipt';
        case 'proforma':
          return 'Proforma Invoice / Quotation';
        case 'receipt':
          return 'Payment Receipt';
        default:
          return 'Invoice';
      }
    }

    function getMetaLabel(type) {
      if (type === 'advance' || type === 'receipt') return 'Receipt #';
      return 'Invoice #';
    }

    function updateInvoice() {
      // Read form values
      invoiceData.documentType = document.getElementById('documentType').value;
      invoiceData.invoiceNumber = document.getElementById('invoiceNumber').value;
      invoiceData.date = document.getElementById('invoiceDate').value;
      invoiceData.advancedPayment = parseFloat(document.getElementById('advancedPayment').value) || 0;

      invoiceData.paymentMethod = document.getElementById('paymentMethod').value;
      invoiceData.transactionRef = document.getElementById('transactionRef').value;

      // Update header title & labels
      const docTitle = getDocumentTitle(invoiceData.documentType);
      document.getElementById('documentTitle').textContent = docTitle;
      document.getElementById('metaLabel').textContent = getMetaLabel(invoiceData.documentType);

      // Update date and number
      document.getElementById('displayInvoiceNumber').textContent = invoiceData.invoiceNumber || '';
      document.getElementById('displayInvoiceDate').textContent = formatDate(invoiceData.date);

      // Show/hide payment fields (advance + receipt only)
      const showPaymentFields = (invoiceData.documentType === 'advance' || invoiceData.documentType === 'receipt');
      document.getElementById('paymentMethodGroup').style.display = showPaymentFields ? 'block' : 'none';
      document.getElementById('transactionRefGroup').style.display = showPaymentFields ? 'block' : 'none';

      // Amount label tweak
      const amountPaidLabel = document.getElementById('amountPaidLabel');
      if (invoiceData.documentType === 'invoice') amountPaidLabel.textContent = 'Advanced / Amount Paid (LKR)';
      if (invoiceData.documentType === 'advance') amountPaidLabel.textContent = 'Advance Paid (LKR)';
      if (invoiceData.documentType === 'proforma') amountPaidLabel.textContent = 'Advance / Amount Paid (LKR)';
      if (invoiceData.documentType === 'receipt') amountPaidLabel.textContent = 'Amount Received (LKR)';

      // STATUS: PAID (Receipt only)
      const paymentStatusEl = document.getElementById('paymentStatus');
      paymentStatusEl.style.display = (invoiceData.documentType === 'receipt') ? 'block' : 'none';

      // Receipt reference line (Receipt only)
      const receiptRef = document.getElementById('receiptRef');
      const receiptInvoiceRef = document.getElementById('receiptInvoiceRef');
      const paymentMetaInline = document.getElementById('paymentMetaInline');

      if (invoiceData.documentType === 'receipt') {
        receiptRef.style.display = 'block';
        receiptInvoiceRef.textContent = invoiceData.invoiceNumber || '';

        const parts = [];
        if (invoiceData.paymentMethod) parts.push(`Method: <strong>${escapeHtml(invoiceData.paymentMethod)}</strong>`);
        if (invoiceData.transactionRef) parts.push(`Ref: <strong>${escapeHtml(invoiceData.transactionRef)}</strong>`);
        paymentMetaInline.innerHTML = parts.length ? parts.join(' &nbsp; | &nbsp; ') : '';
      } else {
        receiptRef.style.display = 'none';
        paymentMetaInline.innerHTML = '';
      }

      // Update items table and subtotal
      const tableBody = document.getElementById('invoiceItemsTable');
      tableBody.innerHTML = '';

      let subTotal = 0;
      invoiceData.items.forEach(item => {
        const qty = parseFloat(item.quantity) || 0;
        const price = parseFloat(item.unitPrice) || 0;
        const total = qty * price;
        subTotal += total;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="col-desc">${escapeHtml(item.description)}</td>
          <td class="col-qty">${qty}</td>
          <td class="col-unit amount">${formatCurrency(price)}</td>
          <td class="col-total amount">${formatCurrency(total)}</td>
        `;
        tableBody.appendChild(row);
      });

      // Summary elements
      const row1 = document.getElementById('summaryRow1');
      const row2 = document.getElementById('summaryRow2');
      const row3 = document.getElementById('summaryRow3');

      const label1 = document.getElementById('summaryLabel1');
      const label2 = document.getElementById('summaryLabel2');
      const label3 = document.getElementById('summaryLabel3');

      const subTotalEl = document.getElementById('subTotal');
      const advancedEl = document.getElementById('advancedAmount');
      const totalEl = document.getElementById('totalAmount');

      // Default: show all rows
      row1.style.display = 'flex';
      row2.style.display = 'flex';
      row3.style.display = 'flex';

      let totalAmount = subTotal - invoiceData.advancedPayment;

      // Adjust labels and visibility per document type
      if (invoiceData.documentType === 'invoice') {
        label1.textContent = 'Sub Total';
        label2.textContent = 'Advanced';
        label3.textContent = 'Balance Payable';

      } else if (invoiceData.documentType === 'advance') {
        label1.textContent = 'Total Booking Value';
        label2.textContent = 'Advance Paid';
        label3.textContent = 'Balance Payable';

      } else if (invoiceData.documentType === 'proforma') {
        label1.textContent = 'Estimated Total';
        row2.style.display = 'none';
        row3.style.display = 'none';

      } else if (invoiceData.documentType === 'receipt') {
        label1.textContent = 'Invoice Total';
        label2.textContent = 'Amount Received';
        label3.textContent = 'Balance Due';

        // Typically receipts are issued when paid-in-full; enforce sensible display
        if (invoiceData.advancedPayment >= subTotal) {
          totalAmount = 0;
        }
      }

      // Update numeric values
      subTotalEl.textContent = formatCurrency(subTotal);
      advancedEl.textContent = formatCurrency(invoiceData.advancedPayment);
      totalEl.textContent = formatCurrency(totalAmount < 0 ? 0 : totalAmount);
    }

    function customPrint() {
      const inputPanel = document.querySelector('.input-panel');
      inputPanel.style.display = 'none';

      document.body.style.width = '900px';
      document.body.style.maxWidth = '900px';
      document.body.style.minWidth = '900px';

      window.print();

      setTimeout(() => {
        inputPanel.style.display = 'block';
        document.body.style.width = '';
        document.body.style.maxWidth = '';
        document.body.style.minWidth = '';
      }, 100);
    }

    function getFileDocTypeName(type) {
      switch (type) {
        case 'advance':
          return 'Advance_Receipt';
        case 'proforma':
          return 'Proforma_Invoice';
        case 'receipt':
          return 'Payment_Receipt';
        default:
          return 'Invoice';
      }
    }

    function downloadPDF() {
      const inputPanel = document.querySelector('.input-panel');
      const invoiceElement = document.querySelector('.page');
      const logo = document.querySelector('.brand-logo');
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

      if (typeof html2pdf === 'undefined') {
        customPrint();
        return;
      }

      // Show loading state on mobile
      if (isMobile) {
        const btn = event ? event.target : null;
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Generating...';
        }
      }

      const originalBodyPadding = document.body.style.padding;
      const originalContainerDisplay = document.querySelector('.container').style.display;

      const originalStyles = {
        margin: invoiceElement.style.margin,
        boxShadow: invoiceElement.style.boxShadow,
        borderRadius: invoiceElement.style.borderRadius,
        width: invoiceElement.style.width,
        maxWidth: invoiceElement.style.maxWidth,
        padding: invoiceElement.style.padding
      };

      // Hide input panel and prepare invoice for capture
      inputPanel.style.display = 'none';
      document.body.style.padding = '0';
      document.querySelector('.container').style.display = 'block';

      invoiceElement.style.margin = '0 auto';
      invoiceElement.style.boxShadow = 'none';
      invoiceElement.style.borderRadius = '0';
      invoiceElement.style.width = '210mm';
      invoiceElement.style.maxWidth = '210mm';
      invoiceElement.style.padding = '40px 50px';

      const docTypeName = getFileDocTypeName(invoiceData.documentType);

      const opt = {
        margin: [0, 0, 0, 0],
        filename: `Sunset_Escape_${docTypeName}_${invoiceData.invoiceNumber || new Date().getTime()}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          logging: false,
          scrollY: -window.scrollY,
          scrollX: -window.scrollX,
          windowWidth: 794,
          windowHeight: 1123,
          width: 794,
          height: invoiceElement.scrollHeight
        },
        jsPDF: {
          unit: 'mm',
          format: 'a4',
          orientation: 'portrait',
          compress: true
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };

      // Add small delay to ensure rendering is complete
      setTimeout(() => {
        html2pdf()
          .set(opt)
          .from(invoiceElement)
          .save()
          .then(() => {
          // Save and auto-increment invoice number after successful PDF generation
          saveAndIncrementInvoiceNumber(invoiceData.invoiceNumber);
          
          // Update to next invoice number for the next invoice
          invoiceData.invoiceNumber = getNextInvoiceNumber();
          document.getElementById('invoiceNumber').value = invoiceData.invoiceNumber;
          updateInvoice();
          
          inputPanel.style.display = 'block';
          document.body.style.padding = originalBodyPadding;
            document.querySelector('.container').style.display = originalContainerDisplay;

            invoiceElement.style.margin = originalStyles.margin;
            invoiceElement.style.boxShadow = originalStyles.boxShadow;
            invoiceElement.style.borderRadius = originalStyles.borderRadius;
            invoiceElement.style.width = originalStyles.width;
            invoiceElement.style.maxWidth = originalStyles.maxWidth;
            invoiceElement.style.padding = originalStyles.padding;

            // Reset button state on mobile
            if (isMobile) {
              const btn = event ? event.target : document.querySelector('.btn-secondary');
              if (btn) {
                btn.disabled = false;
                btn.textContent = 'Download PDF';
              }
            }

            // Show success message on mobile
            if (isMobile && isIOS) {
              alert('PDF generated successfully! Check your Files app or browser downloads.');
            }
          })
          .catch(err => {
            console.error('PDF generation error:', err);
            inputPanel.style.display = 'block';
            document.body.style.padding = originalBodyPadding;
            document.querySelector('.container').style.display = originalContainerDisplay;

            invoiceElement.style.margin = originalStyles.margin;
            invoiceElement.style.boxShadow = originalStyles.boxShadow;
            invoiceElement.style.borderRadius = originalStyles.borderRadius;
            invoiceElement.style.width = originalStyles.width;
            invoiceElement.style.maxWidth = originalStyles.maxWidth;
            invoiceElement.style.padding = originalStyles.padding;

            // Reset button state on mobile
            if (isMobile) {
              const btn = event ? event.target : document.querySelector('.btn-secondary');
              if (btn) {
                btn.disabled = false;
                btn.textContent = 'Download PDF';
              }
              alert('PDF generation failed. Falling back to print...');
            }

            customPrint();
          });
      }, 100);
    }

    document.addEventListener('DOMContentLoaded', initializeForm);
  </script>
</body>

</html>
